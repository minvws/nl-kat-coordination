#!/bin/bash -e

set -e

if [ "$1" = "configure" ]; then
    # Set SECRET_KEY if empty
    key=$(tr -dc A-Za-z0-9 < /dev/urandom | head -c 64)
    sed -i "s/SECRET_KEY= *\$/SECRET_KEY=${key}/" /etc/kat/rocky.conf

    if [ "$2" = "" ]; then
        # $2 is the previously installed version and empty on fresh installs
        if [ ! -f /etc/kat/rocky.local.crt ]; then
            openssl req -x509 -newkey rsa:4096 \
                -keyout /etc/kat/rocky.local.key \
                -out /etc/kat/rocky.local.crt -sha256 \
                -days 365 -nodes -subj '/CN=rocky.local'
        fi

        # Only configure granian for new installs. Existing installations will
        # switch in the next release.
        mkdir -p /etc/systemd/system/kat-rocky.service.d
        cat > /etc/systemd/system/kat-rocky.service.d/use-granian.conf <<EOF
# Do not customize this file because it will be automatically removed in the next release
[Service]
ExecStart=
ExecStart=/opt/venvs/kat-rocky/bin/granian --workers $GRANIAN_WORKERS --threads $GRANIAN_THREADS --host $GRANIAN_HOST --port $GRANIAN_PORT --interface wsgi $GRANIAN_OPTIONS rocky.wsgi:application
EOF
    fi

fi

#DEBHELPER#

if [ "$1" = "configure" ]; then
    chown -R root:kat /etc/kat
    chown root:kat /etc/kat/rocky.local.key
    chown root:kat /etc/kat/rocky.local.crt
    chmod 640 /etc/kat/rocky.local.{key,crt}
fi
