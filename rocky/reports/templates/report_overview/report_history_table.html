{% load i18n %}
{% load static %}
{% load ooi_extra %}
{% load report_extra %}
{% load component_tags %}
{% load compress %}

<div class="horizontal-view toolbar">
    <div class="dropdown">
        {% comment %} <p class="visually-hidden" id="language-selector-description">{% translate "Select your language" %}</p> {% endcomment %}
        <button aria-label="{{ aria_label_current_language }}"
                type="button"
                aria-haspopup="listbox"
                aria-current="true"
                class="dropdown-button ghost">
            {% translate "Actions" %}
            <span class="icon ti-chevron-down"></span>
        </button>
        <div class="dropdown-list">
            <ul role="listbox">
                <li>
                    <a href="#rerun-modal" role="option" data-value="test">
                        <i class="icon ti-refresh"></i>{% translate "Rerun" %}
                    </a>
                </li>
                {% comment %} <li>
                    <a href="#" role="option" data-value="test">
                        <i class="icon ti-calendar-event"></i>{% translate "Reschedule" %}
                    </a>
                </li> {% endcomment %}
                <li>
                    <a href="#" role="option" data-value="test">
                        <i class="icon ti-share"></i>{% translate "Share" %}
                    </a>
                </li>
                {% comment %} <li>
                  <a href="#" role="option" data-value="test">
                    <i class="icon ti-layers-difference"></i>{% translate "Concatenate" %}
                  </a>
                </li> {% endcomment %}
                <li>
                    <a href="#rename-modal" role="option" data-value="test">
                        <i class="icon ti-edit"></i>{% translate "Rename" %}
                    </a>
                </li>
                <li>
                    <a href="#delete-modal"
                       class="plain destructive"
                       role="option"
                       data-value="test">
                        <i class="icon ti-trash"></i>{% translate "Delete" %}
                    </a>
                </li>
            </ul>
        </div>
        {% include "report_overview/modal_partials/rerun_modal.html" %}
        {% include "report_overview/modal_partials/rename_modal.html" %}
        {% include "report_overview/modal_partials/delete_modal.html" %}

    </div>
</div>
<div class="horizontal-scroll">
    {% if reports %}
        <p class="de-emphasized">
            {% blocktranslate with length=reports|length total=total_oois %}Showing {{ length }} of {{ total }} reports{% endblocktranslate %}
        </p>
        <div class="horizontal-scroll">
            <form class="inline layout-wide">
                <table>
                    <caption class="visually-hidden">{% translate "Reports:" %}</caption>
                    <thead>
                        <tr>
                            <th>
                                <input class="select_all_objects_element"
                                       type="checkbox"
                                       {% if "all" in selected_reports %}checked{% endif %}>
                            </th>
                            <th scope="col">{% translate "Name" %}</th>
                            <th scope="col">{% translate "Report type" %}</th>
                            <th scope="col">{% translate "Input Objects" %}</th>
                            <th scope="col">{% translate "Reference date" %}</th>
                            <th scope="col">{% translate "Creation date" %}</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports %}
                            <tr>
                                <td>
                                    <input type="checkbox"
                                           class="report-checkbox"
                                           name="report"
                                           value="{{ report.parent_report.reference }}"
                                           {% if report.id in selected_reports or "all" in selected_reports %}checked{% endif %}
                                           {% if "all" in selected_reports %}disabled{% endif %}>
                                </td>
                                <td class="report_name">
                                    <a id="report_name_{{ report.parent_report.reference|slugify }}"
                                       href="{% url "view_report" organization.code %}?report_id={{ report.parent_report.reference }}&observed_at={{ report.parent_report.observed_at|date:"Y-m-d H:i:s:u" }}"
                                       title="{% translate "Shows parent report details" %}">{{ report.parent_report.name }}</a>
                                </td>
                                <td>
                                    <ul class="tags horizontal-view">
                                        {% if report.parent_report.report_type == "concatenated-report" or report.parent_report.report_type is None %}
                                            {% for report_type, total_objects in report.report_type_summary.items %}
                                                {% if forloop.counter0 < 2 %}
                                                    <li class="label tags-color-{{ report_type|get_report_type_label_style }}">{{ report_type|get_report_type_name }}</li>
                                                {% endif %}
                                                {% if forloop.counter0 == 2 %}
                                                    <li class="label tags-color-grey-2">+ {{ report.report_type_summary|length|add:"-2" }}</li>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <li class="label tags-color-{{ report.parent_report.report_type|get_report_type_label_style }}">
                                                {{ report.parent_report.report_type|get_report_type_name }}
                                            </li>
                                        {% endif %}
                                    </ul>
                                </td>
                                <td>
                                    {% if report.parent_report.input_oois|length == 1 %}
                                        <a href="{% ooi_url "ooi_detail" report.parent_report.input_oois.0 organization.code query=ooi.mandatory_fields %}">{{ report.parent_report.input_oois.0|human_readable }}</a>
                                    {% elif report.total_objects == 1 %}
                                        <a href="{% ooi_url 'ooi_detail' report.children_reports.0.input_oois.0 organization.code query=ooi.mandatory_fields %}">{{ report.children_reports.0.input_oois.0|human_readable }}</a>
                                    {% else %}
                                        {{ report.total_objects }}
                                    {% endif %}
                                </td>
                                <td class="nowrap">{{ report.parent_report.observed_at|date }}</td>
                                <td class="nowrap">{{ report.parent_report.date_generated }}</td>
                                <td>
                                    {% if report.children_reports %}
                                        <button type="button"
                                                class="expando-button icon ti-chevron-down"
                                                data-icon-open-class="icon ti-chevron-down"
                                                data-icon-close-class="icon ti-chevron-up"
                                                data-close-label="{% translate "Close children report object details" %}"
                                                aria-expanded="false">
                                            {% translate "Open children report object details" %}
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if report.children_reports %}
                                <tr class="expando-row">
                                    <td colspan="6">
                                        <table>
                                            <caption class="visually-hidden">{% translate "Subreports details:" %}</caption>
                                            <h5>{% translate "Report types" %}</h5>
                                            <p>
                                                {% blocktranslate count counter=report.total_children_reports %}
                                        This report consist of {{counter}} subreport with the following report type and object.
                                    {% plural %}
                                        This report consist of {{counter}} subreports with the following report types and objects.
                                    {% endblocktranslate %}
                                            </p>
                                            <thead>
                                                <tr>
                                                    <th scope="col">{% translate "Report type" %}</th>
                                                    <th scope="col">{% translate "Objects" %}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for report_type, total_objects in report.report_type_summary.items %}
                                                    <tr>
                                                        <td>
                                                            <ul class="tags horizontal-view">
                                                                <li class="label tags-color-{{ report_type|get_report_type_label_style }}">{{ report_type|get_report_type_name }}</li>
                                                            </ul>
                                                        </td>
                                                        <td>{{ total_objects }}</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        <table>
                                            <h5>
                                                {% translate "Subreports" %}
                                                ({{ report.children_reports|length }}/{{ report.total_children_reports }})
                                            </h5>
                                            <thead>
                                                <tr>
                                                    <th scope="col">{% translate "Report type" %}</th>
                                                    <th scope="col">{% translate "Object" %}</th>
                                                    <th scope="col">{% translate "Report name" %}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for child_report in report.children_reports %}
                                                    <tr>
                                                        <td>
                                                            <ul class="tags horizontal-view">
                                                                <li class="label tags-color-{{ child_report.report_type|get_report_type_label_style }}">
                                                                    {{ child_report.report_type|get_report_type_name }}
                                                                </li>
                                                            </ul>
                                                        </td>
                                                        <td>
                                                            <a href="{% ooi_url 'ooi_detail' child_report.input_oois.0 organization.code %}">{{ child_report.input_oois.0|human_readable }}</a>
                                                        </td>
                                                        <td>
                                                            <a href="{% url "view_report" organization.code %}?report_id={{ child_report }}&observed_at={{ child_report.observed_at|date:"Y-m-d H:i:s:u" }}"
                                                               title="{% translate "Shows subreport details" %}">{{ child_report.name }}</a>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        <div class="button-container">
                                            {% if report.total_children_reports > 5 %}
                                                <a href="{% url "subreports" organization.code %}?report_id={{ report.parent_report.reference }}"
                                                   class="button">{% translate "View all subreports" %}</a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </form>
        </div>
    {% else %}
        <p>{% translate "No reports have been generated yet." %}</p>
    {% endif %}
</div>
<form novalidate id="select_all_objects_form" class="inline" method="get">
    {% include "forms/report_form_fields.html" with selected_reports=None %}

    {% if "all" not in selected_reports %}<input type="hidden" name="report" value="all">{% endif %}
</form>
{% block html_at_end_body %}
    {% compress js %}
        <script src="{% static "modal/script.js" %}" nonce="{{ request.csp_nonce }}" type="module"></script>
        <script src="{% static "js/grabSelectionOnModalOpen.js" %}" nonce="{{ request.csp_nonce }}" type="module"></script>
        <script src="{% static "js/checkboxToggler.js" %}" nonce="{{ request.csp_nonce }}"></script>
    {% endcompress %}
{% endblock html_at_end_body %}
