{% load i18n %}
{% load report_extra %}

{% if data|sum_findings == 0 %}
    <p class="toggle-item" data-show="off">{% translate "No vulnerabilities have been found on this system." %}</p>
{% else %}
    {% for ip, vulnerability_data in data.items %}
        {% if vulnerability_data.summary.total_findings > 0 %}
            <h3>{% translate "Host:" %} {{ ip|human_readable }} {{ vulnerability_data.hostnames }}</h3>
            <p class="toggle-item" data-show="off">
                {% blocktranslate trimmed %}
                    The Vulnerability Report provides an overview of all identified CVE
                    vulnerabilities that were identified on the selected systems. For
                    each CVE the table shows the CVE scoring, the number of occurrences,
                    and the CVE details.
                {% endblocktranslate %}
            </p>
            <p>
                <strong>{{ vulnerability_data.summary.total_findings }}</strong> {% translate "vulnerabilities on this system" %}
            </p>
            <div class="horizontal-scroll sticky-column">
                <table class="nowrap">
                    <caption class="visually-hidden">{% translate "Vulnerabilities" %}</caption>
                    <thead>
                        <tr>
                            <th scope="col">{% translate "Vulnerabilities" %}</th>
                            <th scope="col">{% translate "Risk level" %}</th>
                            <th scope="col">{% translate "Occurrences" %}</th>
                            <th scope="col" class="visually-hidden actions">{% translate "Details" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vulnerability_name, vulnerability in vulnerability_data.vulnerabilities.items %}
                            <tr>
                                <td>{{ vulnerability_name }}</td>
                                <td>
                                    <span class="{{ vulnerability.cvss.class }}">{{ vulnerability.cvss.severity }}</span>
                                </td>
                                <td>{{ vulnerability.occurrences }}</td>
                                <td class="actions sticky-cell">
                                    <button class="expando-button"
                                            data-icon-open-class="icon ti-chevron-down"
                                            data-icon-close-class="icon ti-chevron-up"
                                            data-close-label="{% translate "Close details" %}">
                                        {% translate "Open details" %}
                                    </button>
                                </td>
                            </tr>
                            <tr class="expando-row">
                                <td colspan="5">
                                    <dl>
                                        <div>
                                            <dt>{% translate "Description" %}</dt>
                                            <dd>
                                                {{ vulnerability.description }}
                                            </dd>
                                        </div>
                                        <div>
                                            <dt>{% translate "Advice" %}</dt>
                                            <dd>
                                                {{ vulnerability.advice }}
                                            </dd>
                                        </div>
                                    </dl>
                                    <p>{% translate "Findings" %}</p>
                                    <ul class="accordion break-title">
                                        {% for finding, finding_details in vulnerability.findings.items %}
                                            <li>
                                                <button aria-expanded="false">{{ finding }}</button>
                                                <div aria-labelledby="finding-details">
                                                    <dl>
                                                        {% for key, value in finding_details.items %}
                                                            <div>
                                                                <dt>{{ key }}</dt>
                                                                <dd>
                                                                    {% if key == "Evidence" %}
                                                                        <a href="{% url 'download_task_meta' organization_code=organization.code task_id=value %}"><span class="icon ti-download"></span>{{ value }}</a>
                                                                    {% else %}
                                                                        {{ value }}
                                                                    {% endif %}
                                                                </dd>
                                                            </div>
                                                        {% endfor %}
                                                    </dl>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    {% endfor %}
{% endif %}
