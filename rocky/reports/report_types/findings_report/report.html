{% load i18n %}
{% load ooi_extra %}

{% if show_introduction %}
    <p>
        {% blocktranslate trimmed %}
            The Findings Report contains information about the findings that have been identified
            for the selected asset and organization.
        {% endblocktranslate %}
    </p>
{% endif %}
{% if is_dashboard_findings %}
    <div class="horizontal-scroll">
        <table>
            <caption class="visually-hidden">{% translate "Findings per organization overview" %}</caption>
            <thead>
                <tr>
                    <th>{% translate "Organization" %}</th>
                    <th scope="col">{% translate "Finding types" %}</th>
                    <th scope="col">{% translate "Occurrences" %}</th>
                    <th scope="col">{% translate "Highest risk level" %}</th>
                    <th scope="col">{% translate "Critical finding types" %}</th>
                    <th scope="col" class="visually-hidden actions">{% translate "Details" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for organization, organization_dashboards in organizations_dashboards.items %}
                    {% for dashboards in organization_dashboards %}
                        {% for dashboard_data, report in dashboards.items %}
                            {% with findings=report.report_data.findings %}
                                {% if findings %}
                                    <tr>
                                        <td>{{ organization.name }}</td>
                                        <td>
                                            {% if findings.summary.total_finding_types %}
                                                {{ findings.summary.total_finding_types }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if findings.summary.total_occurrences %}
                                                {{ findings.summary.total_occurrences }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if report.highest_risk_level %}
                                                <span class="{{ report.highest_risk_level }}">{{ report.highest_risk_level|capfirst }}</span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if findings.summary.total_by_severity_per_finding_type %}
                                                {{ findings.summary.total_by_severity_per_finding_type.critical }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="actions">
                                            <button class="expando-button"
                                                    data-icon-open-class="icon ti-chevron-down"
                                                    data-icon-close-class="icon ti-chevron-up"
                                                    data-close-label="{% translate "Close details" %}">
                                                {% translate "Open details" %}
                                            </button>
                                        </td>
                                    </tr>
                                    <tr class="expando-row">
                                        <td colspan="6">
                                            <div>
                                                <h5>{% translate "Findings overview" %}</h5>
                                                <p>
                                                    {% translate "This overview shows the total number of findings per severity that have been identified for this organization." %}
                                                </p>
                                            </div>
                                            {% include "partials/report_severity_totals_table.html" with data=findings.summary %}

                                            <div>
                                                <h5>
                                                    {% translate "Critical and high findings" %} ({{ findings.finding_types|length }}/{{ findings.summary.total_finding_types }})
                                                </h5>
                                                <p>
                                                    {% blocktranslate %}
                                                    This table shows the top 25 critical and high findings that have
                                                    been identified for this organization, grouped by finding types.
                                                    A table with all the identified findings can be found in the Findings Report.
                                                {% endblocktranslate %}
                                                </p>
                                            </div>
                                            {% if findings.finding_types %}
                                                {% include "partials/report_findings_table.html" with finding_types=findings.finding_types %}

                                            {% else %}
                                                <p>{% translate "No critical and high finding types have been identified for this organization." %}</p>
                                            {% endif %}
                                            <a class="button ghost"
                                               href="{% url "view_report" organization.code %}?report_id={{ report.report_id }}#findings">{% translate "View findings report" %}</a>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
{% elif is_dashboard %}
    <div class="horizontal-scroll">
        <h5>{% translate "Findings overview" %}</h5>
        {% include "partials/report_severity_totals_table.html" with data=data.findings.summary %}

        <h5>{% translate "Findings" %}</h5>
        {% include "partials/report_findings_table.html" with finding_types=data.findings.finding_types %}

    </div>
{% else %}
    <div class="horizontal-scroll">
        <h3 id="findings-overview">{% translate "Findings overview" %}</h3>
        <p>
            {% blocktranslate %}
                This overview shows the total number of findings per
                severity that have been identified for this organization.
            {% endblocktranslate %}
        </p>
        {% include "partials/report_severity_totals_table.html" with data=data.summary %}

        <h3 id="findings-table">{% translate "Findings" %}</h3>
        <p>
            {% blocktranslate %}
                This table provides an overview of the identified findings on the scanned
                systems. For each finding type it shows the risk level, the number of occurrences
                and the first known occurrence of the finding. The risk level may be different for your specific environment.
                The details can be seen when expanding a row. A description, the source, impact and recommendation of the finding
                can be found here. It also shows in which findings the finding type occurred.
            {% endblocktranslate %}
        </p>
        {% include "partials/report_findings_table.html" with finding_types=data.finding_types %}

    </div>
{% endif %}
