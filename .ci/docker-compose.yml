services:
  openkat_tests:
    build:
      context: ..
      args:
        ENVIRONMENT: dev
        USER_UID: 1001
        USER_GID: 1001
      target: dev
    command: pytest --cov --cov-report xml --cov-branch --cov-report=term-missing:skip-covered tests/
    depends_on:
      - postgres
    volumes:
      - ..:/app/openkat
    env_file:
      - .env.test

  openkat_integration:
    build:
      context: ..
      args:
        ENVIRONMENT: dev
        USER_UID: 1001
        USER_GID: 1001
      target: dev
    command: pytest -n 0 tests/integration
    depends_on:
      - postgres
      - redis
      - xtdb
      - openkat-test-api
    volumes:
      - ..:/app/openkat
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - HOST_MOUNT_DIR=${PWD}
      - DATABASE_MIGRATION=true
    env_file:
      - .env.test
    networks:
      - default
      - plugins

  openkat-test-api:
    build:
      context: ..
      args:
        ENVIRONMENT: dev
        USER_UID: 1001
        USER_GID: 1001
      target: dev
    command: python3 manage.py runserver 0.0.0.0:8000
    depends_on:
      - postgres
      - redis
      - xtdb
    volumes:
      - ..:/app/openkat
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - HOST_MOUNT_DIR=${PWD}
      - DATABASE_MIGRATION=false
    env_file:
      - .env.test
    networks:
      - default
      - plugins

  postgres:
    image: docker.io/library/postgres:15
    env_file:
      - .env.test

  xtdb:
    image: "ghcr.io/xtdb/xtdb:nightly-20250912"
    environment:
      - XTDB_LOGGING_LEVEL=DEBUG

  redis:
    restart: on-failure
    image: docker.io/library/redis:8.0.3-alpine
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$${REDIS_PASSWORD}"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 5s
      retries: 4
    env_file:
      - .env.test

networks:
  default:
    enable_ipv6: true
    ipam:
      config:
        - subnet: 2001:ab8:d0cb::/64
        - subnet: 172.24.0.1/16
          gateway: 172.24.0.2
  plugins:
    enable_ipv6: true
    ipam:
      config:
        - subnet: 2001:db8:d0cc::/64
        - subnet: 172.26.0.3/16
          gateway: 172.26.0.4
