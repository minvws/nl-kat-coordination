import json
import logging
from ipaddress import ip_address
from os import getenv

import telnetlib

from boefjes.job_models import BoefjeMeta

SMTP_PORT = 25
TIMEOUT = 5


def run(boefje_meta: BoefjeMeta) -> list[tuple[set, bytes | str]]:
    mailserver_ip = getenv("MICROSOFT_MAILSERVER_IP")
    recipient_email = getenv("RECIPIENT_EMAIL")
    hostname = boefje_meta.arguments["input"]["name"]

    telnet = telnetlib.Telnet(mailserver_ip, SMTP_PORT)

    telnet.read_until(b"220", timeout=TIMEOUT)
    telnet.write(b"HELO example.com\r\n")
    telnet.read_until(b"250", timeout=TIMEOUT)

    mail_from = f"MAIL FROM:spoofed@{hostname}\r\n"
    telnet.write(mail_from.encode())
    telnet.read_until(b"250", timeout=TIMEOUT)

    rcpt_to = f"RCPT TO:{recipient_email}\r\n"
    telnet.write(rcpt_to.encode())
    telnet.read_until(b"250", timeout=TIMEOUT)

    telnet.write(b"DATA\r\n")
    telnet.read_until(b"354", timeout=TIMEOUT)  # 354 indicates that the server is ready to receive data

    data = (
        f"From:Spoofed Email <spoofed@{hostname}>\r\n"
        f"To:My Name <{recipient_email}>\r\n"
        f"Subject:Example Spoofing Mail\r\n"
        "\r\n"
        "Are you reading this mail? Then you are vulnerable to spoofing.\r\n"
        "\r\n"
        ".\r\n"
    )
    telnet.write(data.encode())

    response = telnet.read_until(b"250", timeout=TIMEOUT)
    results = response.decode()

    telnet.write(b"quit\r\n")
    telnet.close()

    return [(set(), json.dumps(results))]
