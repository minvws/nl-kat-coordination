#!/usr/bin/make -f
# You must remove unused comment lines for the released package.
export DH_VERBOSE = 1
export DESTDIR = $(CURDIR)/debian/kat-openkat
export DH_VIRTUALENV_INSTALL_ROOT = /opt/venvs

SNAKE=/usr/bin/python3
PIP_ARGS = --extra-pip-arg "--no-binary" --extra-pip-arg "pillow,psycopg2-binary,reportlab"
EXTRA_REQUIREMENTS=--upgrade-pip --preinstall "setuptools>=65" --preinstall "wheel" $(PIP_ARGS)
PACKAGE=$(shell dh_listpackages)
DH_VENV_ARGS=--python $(SNAKE) $(EXTRA_REQUIREMENTS)
DH_VENV_DIR=debian/$(PACKAGE)$(DH_VIRTUALENV_INSTALL_ROOT)/$(PACKAGE)

%:
	dh $@ --with python-virtualenv

.PHONY: override_dh_virtualenv override_dh_fixperms

override_dh_fixperms:
	dh_fixperms
	chmod 750 $(DESTDIR)/etc/kat/
	find $(DESTDIR)/etc/kat -type f -exec chmod 640 {} \;
	chmod 755 $(DESTDIR)/usr/bin/openkat-cli

override_dh_virtualenv:
# We want to use uv but dh_virtualenv doesn't support that. So we create an
# empty requirements file and call uv manually..
	touch /tmp/requirements-empty.txt
	dh_virtualenv --requirements=/tmp/requirements-empty.txt --skip-install --preinstall "uv"
	$(DH_VENV_DIR)/bin/python -m uv sync --locked
	$(DH_VENV_DIR)/bin/python -m uv export --no-emit-workspace --no-dev --format requirements.txt | grep -v git+https:// > /tmp/requirements-nogit.txt
	$(DH_VENV_DIR)/bin/python -m uv export --no-emit-workspace --no-dev --format requirements.txt | grep git+https://  > /tmp/requirements-git.txt

# remove pip and uv to prevent mutation of venv
	$(DH_VENV_DIR)/bin/python -m uv pip uninstall pip uv
	dh_virtualenv --requirements=/tmp/requirements-nogit.txt $(DH_VENV_ARGS)
	$(DH_VENV_DIR)/bin/python -m pip install -r /tmp/requirements-git.txt

	export SECRET_KEY="secret" REDIS_QUEUE_URI="redis://redis:5672" \
	&& $(DH_VENV_DIR)/bin/python manage.py collectstatic --noinput --clear \
	&& $(DH_VENV_DIR)/bin/python manage.py compress \
	&& $(DH_VENV_DIR)/bin/python manage.py compilemessages \
	&& rm -rf $(DH_VENV_DIR)/bin/__pycache__
	find static -type f -exec install -m 644 -D "{}" "$(DESTDIR)/usr/share/kat-openkat/{}" \;
	find components -type f -name *.html -exec install -m 644 -D "{}" "$(DH_VENV_DIR)/lib/`py3versions -d`/site-packages/{}" \;

# Fix shebang
	sed -i 's|#!.*$(DH_VIRTUALENV_INSTALL_ROOT)/$(PACKAGE)/bin/python|#!$(DH_VIRTUALENV_INSTALL_ROOT)/$(PACKAGE)/bin/python|' $(DH_VENV_DIR)/bin/*

override_dh_gencontrol:
	dh_gencontrol -- -Vpython=`py3versions -d`

override_dh_installsystemd:
	dh_installsystemd --name=kat-openkat
	dh_installsystemd --name=kat-openkat-worker

execute_after_dh_install:
	dh_installsysusers

# Disables dh_strip_nondeterminism because it very slow and not useful for us
override_dh_strip_nondeterminism:

# Disable dh_dwz because it is also not useful for us
override_dh_dwz:

# Let dpkg-shlibdeps ignore venvs
override_dh_shlibdeps:
	dh_shlibdeps -X/opt/venvs

# Workaround error of dh_strip of Pillow on Ubuntu
override_dh_strip:
	dh_strip -Xsite-packages/PIL -Xsite-packages/pillow.libs
